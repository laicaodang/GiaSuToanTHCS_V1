<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gia s∆∞ To√°n L·ªõp 6 - AI</title>
    
    <!-- C·∫•u h√¨nh MathJax ƒë·ªÉ hi·ªÉn th·ªã c√¥ng th·ª©c To√°n h·ªçc ƒë·∫πp m·∫Øt -->
    <script>
        MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']]
            },
            svg: { fontCache: 'global' }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <style>
        :root { --primary-color: #2563eb; --bg-color: #f3f4f6; --chat-bg: #ffffff; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background-color: var(--bg-color); margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; height: 100vh; box-sizing: border-box; }
        
        .container { width: 100%; max-width: 800px; display: flex; flex-direction: column; height: 100%; gap: 15px; }
        
        /* Box nh·∫≠p API Key */
        .api-box { background: var(--chat-bg); padding: 15px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); display: flex; gap: 10px; }
        .api-box input { flex: 1; padding: 10px 15px; border: 1px solid #d1d5db; border-radius: 8px; outline: none; font-size: 14px; }
        .api-box button { background: #10b981; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .api-box button:hover { background: #059669; }

        /* Khung Chat */
        .chat-box { flex: 1; background: var(--chat-bg); border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); display: flex; flex-direction: column; overflow: hidden; }
        .messages { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }
        
        .msg { max-width: 85%; padding: 12px 16px; border-radius: 12px; line-height: 1.6; font-size: 15px; word-wrap: break-word; }
        .msg p { margin: 0 0 10px 0; }
        .msg p:last-child { margin: 0; }
        
        .msg.user { align-self: flex-end; background: var(--primary-color); color: white; border-bottom-right-radius: 2px; }
        .msg.ai { align-self: flex-start; background: #f3f4f6; color: #1f2937; border-bottom-left-radius: 2px; border: 1px solid #e5e7eb; }
        .msg.error { background: #fee2e2; color: #b91c1c; border: 1px solid #fca5a5; font-size: 13px; }

        /* Khung nh·∫≠p tin nh·∫Øn */
        .input-box { display: flex; padding: 15px; border-top: 1px solid #e5e7eb; background: var(--chat-bg); gap: 10px; }
        .input-box input { flex: 1; padding: 12px 15px; border: 1px solid #d1d5db; border-radius: 25px; outline: none; font-size: 15px; }
        .input-box input:focus { border-color: var(--primary-color); }
        .input-box button { background: var(--primary-color); color: white; border: none; padding: 10px 25px; border-radius: 25px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .input-box button:hover { background: #1d4ed8; }
        .input-box button:disabled { background: #9ca3af; cursor: not-allowed; }

        .typing { font-style: italic; color: #6b7280; font-size: 14px; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: .5; } 50% { opacity: 1; } 100% { opacity: .5; } }
        
        /* Hi·ªÉn th·ªã phi√™n b·∫£n ƒë·ªÉ ch·ªëng k·∫πt cache */
        .version-tag { text-align: center; font-size: 12px; color: #9ca3af; padding-top: 5px; }
    </style>
</head>
<body>

<div class="container">
    <div class="api-box">
        <input type="password" id="api-key" placeholder="D√°n Gemini API Key m·ªõi nh·∫•t c·ªßa b·∫°n v√†o ƒë√¢y...">
        <button onclick="saveKey()">üíæ L∆∞u Key</button>
    </div>

    <div class="chat-box">
        <div class="messages" id="chat-messages">
            <div class="msg ai">
                üëã Ch√†o em! Th·∫ßy l√† Gia s∆∞ To√°n. Em ƒëang g·∫∑p kh√≥ khƒÉn v·ªõi b√†i to√°n l·ªõp 6 n√†o, h√£y g√µ v√†o b√™n d∆∞·ªõi nh√©!
            </div>
        </div>
        
        <div class="input-box">
            <input type="text" id="user-input" placeholder="V√≠ d·ª•: T√≠nh t·ªïng S = 1.2 + 2.3 + ... + 99.100" onkeypress="handleEnter(event)">
            <button id="send-btn" onclick="sendMessage()">G·ª≠i</button>
        </div>
    </div>
    
    <div class="version-tag">Phi√™n b·∫£n: 2.0 (·ªîn ƒë·ªãnh - S·ª≠ d·ª•ng c·ªïng v1beta)</div>
</div>

<script>
    // 1. Qu·∫£n l√Ω API Key
    window.onload = () => {
        const savedKey = localStorage.getItem('gemini_api_key');
        if (savedKey) document.getElementById('api-key').value = savedKey;
    };

    function saveKey() {
        const key = document.getElementById('api-key').value.trim();
        if (key) {
            localStorage.setItem('gemini_api_key', key);
            alert('‚úÖ ƒê√£ l∆∞u API Key th√†nh c√¥ng!');
        } else {
            alert('‚ö†Ô∏è Vui l√≤ng nh·∫≠p Key tr∆∞·ªõc khi l∆∞u!');
        }
    }

    // 2. X·ª≠ l√Ω g·ª≠i tin nh·∫Øn
    function handleEnter(e) {
        if (e.key === 'Enter') sendMessage();
    }

    async function sendMessage() {
        const inputField = document.getElementById('user-input');
        const chatContainer = document.getElementById('chat-messages');
        const sendBtn = document.getElementById('send-btn');
        
        const message = inputField.value.trim();
        
        // C∆† CH·∫æ CH·ªêNG K·∫∏T KEY: Lu√¥n ∆∞u ti√™n Key ƒëang hi·ªÉn th·ªã tr√™n √¥ nh·∫≠p li·ªáu
        const inputKey = document.getElementById('api-key').value.trim();
        const savedKey = localStorage.getItem('gemini_api_key');
        const apiKey = inputKey || savedKey;

        // T·ª± ƒë·ªông l∆∞u n·∫øu c√≥ Key m·ªõi ƒë∆∞·ª£c d√°n v√†o m√† ng∆∞·ªùi d√πng qu√™n b·∫•m "L∆∞u Key"
        if (inputKey && inputKey !== savedKey) {
            localStorage.setItem('gemini_api_key', inputKey);
        }

        if (!message) return;
        
        if (!apiKey) {
            appendMessage('error', '‚ùå L·ªñI: B·∫°n ch∆∞a cung c·∫•p API Key!');
            return;
        }

        // Hi·ªán tin nh·∫Øn ng∆∞·ªùi d√πng
        appendMessage('user', message);
        inputField.value = '';
        
        // Hi·ªán tr·∫°ng th√°i Typing
        const typingId = 'typing-' + Date.now();
        const typingDiv = document.createElement('div');
        typingDiv.className = 'msg ai typing';
        typingDiv.id = typingId;
        typingDiv.innerText = '‚úçÔ∏è Th·∫ßy ƒëang gi·∫£i b√†i...';
        chatContainer.appendChild(typingDiv);
        scrollToBottom();

        // Kh√≥a n√∫t G·ª≠i
        sendBtn.disabled = true;

        try {
            // === C·ªîNG K·∫æT N·ªêI V1BETA CHU·∫®N X√ÅC ===
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`;
            
            const payload = {
                contents: [{
                    role: "user",
                    parts: [{ text: message }]
                }],
                systemInstruction: {
                    parts: [{ text: "B·∫°n l√† m·ªôt gia s∆∞ To√°n c·∫•p 2 xu·∫•t s·∫Øc, ƒë·∫∑c bi·ªát chuy√™n v·ªÅ to√°n l·ªõp 6 t·∫°i Vi·ªát Nam. H√£y gi·∫£i b√†i to√°n ng∆∞·ªùi d√πng ƒë∆∞a ra m·ªôt c√°ch chi ti·∫øt, t·ª´ng b∆∞·ªõc, th√¢n thi·ªán v√† d·ªÖ hi·ªÉu cho h·ªçc sinh 11 tu·ªïi. B·∫ÆT BU·ªòC s·ª≠ d·ª•ng ƒë·ªãnh d·∫°ng LaTeX (k·∫πp gi·ªØa d·∫•u $ ho·∫∑c $$) cho M·ªåI c√¥ng th·ª©c, ph√¢n s·ªë, ph√©p t√≠nh to√°n h·ªçc." }]
                },
                generationConfig: {
                    temperature: 0.2
                }
            };

            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const data = await response.json();

            // X√≥a hi·ªáu ·ª©ng typing
            document.getElementById(typingId).remove();

            // X·ª≠ l√Ω l·ªói t·ª´ Google chi ti·∫øt nh·∫•t
            if (!response.ok) {
                const errorMsg = data.error ? data.error.message : `L·ªói HTTP ${response.status}`;
                throw new Error(errorMsg);
            }

            // Tr√≠ch xu·∫•t vƒÉn b·∫£n tr·∫£ l·ªùi
            if (data.candidates && data.candidates[0].content.parts[0].text) {
                const aiResponse = data.candidates[0].content.parts[0].text;
                appendMessage('ai', aiResponse);
                
                // K√≠ch ho·∫°t MathJax an to√†n
                if (window.MathJax) {
                    MathJax.typesetPromise().catch(err => console.error("L·ªói v·∫Ω c√¥ng th·ª©c To√°n:", err));
                }
            } else {
                throw new Error("API k·∫øt n·ªëi th√†nh c√¥ng nh∆∞ng kh√¥ng tr·∫£ v·ªÅ c√¢u tr·∫£ l·ªùi h·ª£p l·ªá.");
            }

        } catch (error) {
            const typingEl = document.getElementById(typingId);
            if (typingEl) typingEl.remove();
            
            appendMessage('error', `‚ùå L·ªñI T·ª™ M√ÅY CH·ª¶ GOOGLE:<br>${error.message}<br><br><small><i>G·ª£i √Ω: N·∫øu l·ªói ghi l√† "API key not valid", h√£y ki·ªÉm tra l·∫°i Key. N·∫øu l·ªói m·∫°ng, h√£y b·∫≠t VPN.</i></small>`);
            console.error("Chi ti·∫øt l·ªói:", error);
        } finally {
            sendBtn.disabled = false;
            scrollToBottom();
        }
    }

    // H√†m ph·ª• tr·ª£ UI
    function appendMessage(sender, text) {
        const chatContainer = document.getElementById('chat-messages');
        const msgDiv = document.createElement('div');
        msgDiv.className = `msg ${sender}`;
        
        // X·ª≠ l√Ω xu·ªëng d√≤ng
        let formattedText = text.replace(/\n/g, '<br>');
        msgDiv.innerHTML = formattedText;
        
        chatContainer.appendChild(msgDiv);
        scrollToBottom();
    }

    function scrollToBottom() {
        const chatContainer = document.getElementById('chat-messages');
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }
</script>

</body>
</html>